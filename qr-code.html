<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy page</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/media.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <!-- <section class="gradient-block">
            <div class="gradient-block__center"></div>
        </section> -->
        <div class="container">
            <section class="header-section">
                <a href="index.html">
                    <img src="./img/logo.svg" alt="logo.svg" class="logo">
                </a>
                <h2 class="footer-logo-nav__logo logo-nav">
                    <a href="index.html">IT-РЕШЕНИЯ 360</a>
                </h2>
                <div class="burger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <nav class="nav-menu">
                    <ul class="nav-menu-list">
                        <li class="nav-menu-list__item"><a href="index.html">ГЛАВНАЯ</a></li>
                        <li class="nav-menu-list__item"><a href="services.html">УСЛУГИ</a></li>
                        <li class="nav-menu-list__item"><a href="catalog.html">КАТАЛОГ</a></li>
                        <li class="nav-menu-list__item"><a href="about-us.html">О нас</a></li>
                        <li class="nav-menu-list__item"><a href="contacts.html">Контакты</a></li>
                    </ul>
                </nav>
            </section>
        </div>
    </header>

    <main class="main">
        <section class="qr-code-area">
            <div class="container">
                <!-- Здесь будет отображаться QR-код -->
                <div id="qr-container">
                    <p>Сканируйте QR-код для оплаты:</p>
                    <!-- Этот img тег будет динамически обновляться с URL QR-кода -->
                    <img id="payment-qr" src="./img/qr-code.png" alt="QR Код для оплаты" />
                </div>
            </div>
        </section>
        <section class="gradient-block">
            <div class="gradient-block__center"></div>
    </section>
    </main>

    <footer class="footer">
        <div class="footer-shadow"></div>
        <div class="container">
            <div class="footer-logo-nav">
                <h2 class="footer-logo-nav__logo">
                    <a href="index.html">IT-РЕШЕНИЯ 360</a>
                </h2>
                <nav class="footer-logo-nav__nav">
                    <ul class="footer-logo-nav__nav-list">
                        <li class="footer-logo-nav__nav-list-li">
                            <a href="services.html" class="footer-logo-nav__nav-list-link">УСЛУГИ</a>
                        </li>
                        <li class="footer-logo-nav__nav-list-li">
                            <a href="catalog.html" class="footer-logo-nav__nav-list-link">КАТАЛОГ</a>
                        </li>
                        <li class="footer-logo-nav__nav-list-li">
                            <a href="about-us.html" class="footer-logo-nav__nav-list-link">О нас</a>
                        </li>
                        <li class="footer-logo-nav__nav-list-li">
                            <a href="contacts.html" class="footer-logo-nav__nav-list-link">Контакты</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="footer-description">
                <p class="footer-description__text">
                    Сервис, созданный для людей, которым нужно профессиональное сопровождение в освоении, оптимизации и использовании современных технологий
                </p>
            </div>
        </div>
    </footer>
    <script>
         const params = new URLSearchParams(window.location.search);
        const orderId = params.get('id');

        if (!orderId) {
            console.error("Ошибка: нет параметра orderId в URL");
            return;
        }

        // Если у нас есть orderId, мы получаем ссылку на платеж
        fetch('/.netlify/functions/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: orderId, amount: 1000 }) // Здесь amount - это сумма
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Если все в порядке, показываем QR-код
                document.getElementById("payment-qr").src = data.paymentUrl;
            } else {
                console.error("Ошибка:", data.error);
            }
        })
        .catch(err => console.error("Ошибка при получении данных для QR-кода:", err));

        // Функция для проверки статуса платежа
        function checkPaymentStatus() {
            fetch('/.netlify/functions/check-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: orderId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Платеж подтвержден
                    console.log("Статус платежа: подтвержден");
                    window.location.href = '/success.html'; // Перенаправляем на страницу успеха
                } else if (data.status === 'REJECTED') {
                    // Платеж отклонен
                    console.log("Статус платежа: отклонен");
                    window.location.href = '/fail.html'; // Перенаправляем на страницу неудачи
                }
            })
            .catch(err => {
                console.error("Ошибка при проверке платежа:", err);
                window.location.href = '/fail.html'; // В случае ошибки тоже перенаправляем на страницу неудачи
            });
        }

        // Начинаем проверку платежа каждые 5 секунд
        const paymentCheckInterval = setInterval(checkPaymentStatus, 5000);

        // Останавливаем проверку, когда перенаправляем пользователя на страницу успеха или неудачи
        function stopPaymentCheck() {
            clearInterval(paymentCheckInterval);
        }

        // После того как мы делаем редирект, остановим проверку
        window.addEventListener('beforeunload', stopPaymentCheck);
</script>   
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/burger.js"></script>
    <script type="module" src="./js/qr.js"></script>
</body>
</html>